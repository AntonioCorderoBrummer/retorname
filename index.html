<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RetornApp ‚Äì Botellas que vuelven a ti</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green:#2ecc71; --green-d:#27ae60; --teal:#1abc9c; --blue:#3498db;
      --dark:#1a1a2e; --mid:#2d2d44; --light:#f4f7f2;
      --text:#2c3e50; --muted:#7f8c8d; --radius:14px;
      --shadow:0 8px 32px rgba(0,0,0,.12);
    }
    html { scroll-behavior:smooth; }
    body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--light); color:var(--text); min-height:100vh; }

    nav { position:sticky; top:0; z-index:100; background:var(--dark); display:flex; align-items:center; justify-content:space-between; padding:0 2rem; height:64px; box-shadow:0 2px 12px rgba(0,0,0,.3); }
    .logo { display:flex; align-items:center; gap:.6rem; }
    .logo-icon { font-size:1.8rem; }
    .logo-text { font-size:1.4rem; font-weight:800; background:linear-gradient(135deg,var(--green),var(--teal)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .nav-badge { background:var(--green); color:#fff; font-size:.65rem; font-weight:700; padding:.2rem .5rem; border-radius:999px; text-transform:uppercase; }

    .hero { background:linear-gradient(135deg,var(--dark) 0%,var(--mid) 60%,#16213e 100%); color:#fff; text-align:center; padding:5rem 1.5rem 4rem; position:relative; overflow:hidden; }
    .hero::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at 70% 50%,rgba(46,204,113,.15) 0%,transparent 60%); }
    .hero-tag { display:inline-block; background:rgba(46,204,113,.2); border:1px solid var(--green); color:var(--green); font-size:.8rem; font-weight:600; padding:.35rem 1rem; border-radius:999px; margin-bottom:1.4rem; text-transform:uppercase; }
    .hero h1 { font-size:clamp(2rem,5vw,3.4rem); font-weight:900; line-height:1.15; margin-bottom:1.2rem; }
    .hero h1 span { color:var(--green); }
    .hero p { max-width:560px; margin:0 auto 2.4rem; font-size:1.1rem; color:rgba(255,255,255,.75); line-height:1.7; }
    .hero-cta { display:inline-block; background:linear-gradient(135deg,var(--green),var(--teal)); color:#fff; font-weight:700; font-size:1rem; padding:.85rem 2.2rem; border-radius:999px; text-decoration:none; transition:transform .2s,box-shadow .2s; box-shadow:0 4px 20px rgba(46,204,113,.4); }
    .hero-cta:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(46,204,113,.5); }

    .steps-bar { background:#fff; border-bottom:1px solid #e8ecf0; padding:1.2rem 1rem; position:sticky; top:64px; z-index:90; }
    .steps-track { max-width:780px; margin:0 auto; display:flex; align-items:center; }
    .step-item { flex:1; display:flex; flex-direction:column; align-items:center; gap:.3rem; position:relative; }
    .step-item:not(:last-child)::after { content:''; position:absolute; top:18px; left:50%; width:100%; height:2px; background:#dde3e9; z-index:-1; transition:background .4s; }
    .step-item.completed:not(:last-child)::after { background:var(--green); }
    .step-dot { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:.85rem; background:#dde3e9; color:var(--muted); transition:all .3s; border:2px solid transparent; }
    .step-item.active .step-dot { background:var(--green); color:#fff; border-color:var(--green-d); transform:scale(1.15); }
    .step-item.completed .step-dot { background:var(--green-d); color:#fff; }
    .step-label { font-size:.68rem; color:var(--muted); text-align:center; font-weight:500; }
    .step-item.active .step-label { color:var(--green-d); font-weight:700; }
    .step-item.completed .step-label { color:var(--green-d); }

    .form-container { max-width:720px; margin:2.5rem auto; padding:0 1rem 4rem; }
    .card { background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); padding:2rem 2.2rem; margin-bottom:1.5rem; display:none; animation:fadeIn .4s ease; }
    .card.visible { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:none} }
    .card-header { display:flex; align-items:center; gap:1rem; margin-bottom:1.6rem; padding-bottom:1.2rem; border-bottom:2px solid var(--light); }
    .card-num { width:40px; height:40px; flex-shrink:0; border-radius:50%; background:linear-gradient(135deg,var(--green),var(--teal)); color:#fff; font-weight:800; font-size:1.1rem; display:flex; align-items:center; justify-content:center; }
    .card-title { font-size:1.2rem; font-weight:700; color:var(--dark); }
    .card-sub { font-size:.85rem; color:var(--muted); margin-top:.15rem; }

    label { display:block; font-weight:600; font-size:.9rem; margin-bottom:.45rem; color:var(--text); }
    .hint { font-size:.78rem; color:var(--muted); margin-bottom:.7rem; font-weight:400; }
    input[type="text"], select { width:100%; padding:.75rem 1rem; border:2px solid #dde3e9; border-radius:8px; font-size:.95rem; font-family:inherit; background:#fafbfc; color:var(--text); transition:border-color .2s,box-shadow .2s; outline:none; }
    input:focus, select:focus { border-color:var(--green); box-shadow:0 0 0 4px rgba(46,204,113,.12); background:#fff; }

    .super-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:.85rem; margin-top:.5rem; }
    .super-card { border:2px solid #dde3e9; border-radius:10px; padding:1rem .8rem; text-align:center; cursor:pointer; transition:all .2s; background:#fafbfc; }
    .super-card:hover { border-color:var(--green); background:#f0fdf5; }
    .super-card.selected { border-color:var(--green); background:#f0fdf5; box-shadow:0 0 0 3px rgba(46,204,113,.2); }
    .super-icon { font-size:1.8rem; margin-bottom:.4rem; }
    .super-name { font-size:.8rem; font-weight:700; }
    .super-check { display:none; color:var(--green); font-size:.85rem; margin-top:.2rem; font-weight:700; }
    .super-card.selected .super-check { display:block; }

    .counter-row { display:flex; align-items:center; gap:1rem; margin-top:.5rem; }
    .counter-btn { width:44px; height:44px; border-radius:50%; border:2px solid var(--green); background:#fff; color:var(--green); font-size:1.4rem; cursor:pointer; font-weight:700; display:flex; align-items:center; justify-content:center; transition:all .18s; }
    .counter-btn:hover { background:var(--green); color:#fff; }
    .counter-display { font-size:2.2rem; font-weight:900; color:var(--dark); min-width:60px; text-align:center; }
    .counter-label { font-size:.85rem; color:var(--muted); }
    .bottles-info { margin-top:1.2rem; padding:.9rem 1rem; background:linear-gradient(135deg,#f0fdf5,#e8fdf2); border:1px solid #a8e6c1; border-radius:8px; font-size:.85rem; color:var(--green-d); font-weight:500; }

    .bev-group { margin-bottom:1.4rem; }
    .bev-group-label { font-size:.78rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); margin-bottom:.5rem; }
    .bev-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(115px,1fr)); gap:.65rem; }
    .bev-card { border:2px solid #dde3e9; border-radius:8px; padding:.8rem .5rem; text-align:center; cursor:pointer; transition:all .18s; background:#fafbfc; position:relative; }
    .bev-card:hover { border-color:var(--blue); background:#f0f6ff; }
    .bev-card.pick-1 { border-color:var(--green); background:#f0fdf5; }
    .bev-card.pick-2 { border-color:var(--blue); background:#f0f6ff; }
    .bev-card.pick-3 { border-color:#e67e22; background:#fff8f0; }
    .bev-icon { font-size:1.6rem; }
    .bev-name { font-size:.75rem; font-weight:600; margin-top:.3rem; }
    .bev-badge { position:absolute; top:-7px; right:-7px; width:20px; height:20px; border-radius:50%; font-size:.65rem; font-weight:800; color:#fff; display:flex; align-items:center; justify-content:center; }
    .pick-1 .bev-badge { background:var(--green); }
    .pick-2 .bev-badge { background:var(--blue); }
    .pick-3 .bev-badge { background:#e67e22; }
    .bev-legend { display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:.4rem; font-size:.78rem; color:var(--muted); }
    .legend-dot { width:14px; height:14px; border-radius:50%; }

    .address-block { margin-bottom:1.5rem; }
    .address-icon { font-size:1.3rem; margin-right:.4rem; }
    .same-address { display:flex; align-items:center; gap:.5rem; background:#f0fdf5; border:1px solid #a8e6c1; border-radius:8px; padding:.75rem 1rem; cursor:pointer; margin-top:1rem; }
    .same-address input[type="checkbox"] { width:18px; height:18px; accent-color:var(--green); cursor:pointer; }
    .same-address label { margin:0; cursor:pointer; font-size:.9rem; font-weight:500; color:var(--green-d); }

    #map-result { margin-top:1.2rem; padding:1rem; background:#f0fdf5; border:1px solid #a8e6c1; border-radius:8px; display:none; }
    .map-title { font-weight:700; color:var(--green-d); margin-bottom:.5rem; font-size:.9rem; }
    .map-branch { display:flex; align-items:center; gap:.5rem; margin-bottom:.3rem; font-size:.85rem; }
    .map-dist { color:var(--muted); font-size:.78rem; margin-left:auto; }

    .summary-row { display:flex; justify-content:space-between; align-items:center; padding:.65rem 0; border-bottom:1px solid #f0f0f0; font-size:.9rem; }
    .summary-row:last-child { border-bottom:none; }
    .summary-key { color:var(--muted); font-weight:500; }
    .summary-val { font-weight:700; color:var(--dark); text-align:right; max-width:55%; }
    .price-box { margin-top:1.5rem; padding:1.2rem; background:linear-gradient(135deg,var(--dark),var(--mid)); border-radius:10px; color:#fff; text-align:center; }
    .price-label { font-size:.85rem; opacity:.7; margin-bottom:.3rem; }
    .price-amount { font-size:2rem; font-weight:900; color:var(--green); }
    .price-note { font-size:.75rem; opacity:.6; margin-top:.3rem; }

    .btn-row { display:flex; gap:1rem; margin-top:1.8rem; }
    .btn { padding:.8rem 1.8rem; border-radius:999px; border:none; font-size:.95rem; font-weight:700; cursor:pointer; transition:all .2s; flex:1; }
    .btn-primary { background:linear-gradient(135deg,var(--green),var(--teal)); color:#fff; box-shadow:0 4px 16px rgba(46,204,113,.35); }
    .btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(46,204,113,.45); }
    .btn-secondary { background:var(--light); color:var(--text); }
    .btn-secondary:hover { background:#e8ecf0; }

    #success-screen { display:none; text-align:center; padding:3rem 1.5rem 5rem; }
    .success-icon { font-size:5rem; margin-bottom:1rem; animation:bounce .6s ease; }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-18px)} }
    #success-screen h2 { font-size:2rem; font-weight:900; color:var(--dark); margin-bottom:.8rem; }
    #success-screen p { color:var(--muted); font-size:1rem; max-width:420px; margin:0 auto 1.8rem; line-height:1.7; }
    .order-code { display:inline-block; background:var(--dark); color:var(--green); font-family:monospace; font-size:1.3rem; font-weight:800; padding:.6rem 1.4rem; border-radius:8px; letter-spacing:.1em; }

    footer { background:var(--dark); color:rgba(255,255,255,.5); text-align:center; padding:2rem 1rem; font-size:.8rem; }
    footer span { color:var(--green); }
    .toast { position:fixed; bottom:1.5rem; right:1.5rem; z-index:9999; background:#e74c3c; color:#fff; padding:.9rem 1.4rem; border-radius:10px; font-size:.9rem; font-weight:600; box-shadow:0 6px 20px rgba(0,0,0,.2); transform:translateY(20px); opacity:0; transition:all .3s; pointer-events:none; }
    .toast.show { transform:none; opacity:1; }
  </style>
</head>
<body>

<nav>
  <div class="logo">
    <span class="logo-icon">‚ôªÔ∏è</span>
    <span class="logo-text">RetornApp</span>
  </div>
  <span class="nav-badge">Beta</span>
</nav>

<section class="hero">
  <div class="hero-tag">üåø Econom√≠a circular en tu puerta</div>
  <h1>Tus botellas vuelven<br>convertidas en <span>bebidas frescas</span></h1>
  <p>Retiramos tus botellas vac√≠as, las devolvemos al supermercado y te traemos las bebidas que elijas. T√∫ no te mueves.</p>
  <a href="#form-section" class="hero-cta">Solicitar retiro ahora ‚Üí</a>
</section>

<div class="steps-bar">
  <div class="steps-track">
    <div class="step-item active" id="step-ind-1"><div class="step-dot">1</div><div class="step-label">Supermercado</div></div>
    <div class="step-item" id="step-ind-2"><div class="step-dot">2</div><div class="step-label">Botellas</div></div>
    <div class="step-item" id="step-ind-3"><div class="step-dot">3</div><div class="step-label">Bebidas</div></div>
    <div class="step-item" id="step-ind-4"><div class="step-dot">4</div><div class="step-label">Direcci√≥n</div></div>
    <div class="step-item" id="step-ind-5"><div class="step-dot">5</div><div class="step-label">Resumen</div></div>
  </div>
</div>

<div id="form-section" class="form-container">

  <div class="card visible" id="card-1">
    <div class="card-header">
      <div class="card-num">1</div>
      <div><div class="card-title">Elige el supermercado</div><div class="card-sub">Selecciona la cadena donde canjearemos tus botellas</div></div>
    </div>
    <div class="super-grid" id="super-grid"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="goStep(2)">Continuar ‚Üí</button></div>
  </div>

  <div class="card" id="card-2">
    <div class="card-header">
      <div class="card-num">2</div>
      <div><div class="card-title">¬øCu√°ntas botellas vas a retornar?</div><div class="card-sub">Solo se aceptan botellas retornables con logo ‚ôªÔ∏è</div></div>
    </div>
    <div class="counter-row">
      <button class="counter-btn" onclick="changeBottles(-1)">‚àí</button>
      <div class="counter-display" id="bottle-count">0</div>
      <button class="counter-btn" onclick="changeBottles(1)">+</button>
      <div class="counter-label">botellas</div>
    </div>
    <div class="bottles-info" id="bottles-info" style="display:none"></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goStep(1)">‚Üê Atr√°s</button>
      <button class="btn btn-primary" onclick="goStep(3)">Continuar ‚Üí</button>
    </div>
  </div>

  <div class="card" id="card-3">
    <div class="card-header">
      <div class="card-num">3</div>
      <div><div class="card-title">¬øQu√© bebidas quieres de vuelta?</div><div class="card-sub">Elige hasta 3 opciones en orden de preferencia</div></div>
    </div>
    <div class="bev-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div> 1¬™ opci√≥n</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div> 2¬™ opci√≥n</div>
      <div class="legend-item"><div class="legend-dot" style="background:#e67e22"></div> 3¬™ opci√≥n</div>
    </div>
    <div id="bev-groups"></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goStep(2)">‚Üê Atr√°s</button>
      <button class="btn btn-primary" onclick="goStep(4)">Continuar ‚Üí</button>
    </div>
  </div>

  <div class="card" id="card-4">
    <div class="card-header">
      <div class="card-num">4</div>
      <div><div class="card-title">Direcci√≥n de retiro y entrega</div><div class="card-sub">Ingresa las direcciones y encontraremos la sucursal m√°s cercana</div></div>
    </div>
    <div class="address-block">
      <label><span class="address-icon">üì¶</span>Direcci√≥n de retiro</label>
      <div class="hint">Calle, n√∫mero, comuna ‚Äì Ej: Av. Providencia 1234, Santiago</div>
      <input type="text" id="pickup-addr" placeholder="Av. Providencia 1234, Providencia" />
    </div>
    <div class="same-address">
      <input type="checkbox" id="same-chk" onchange="toggleSameAddr()" />
      <label for="same-chk">La entrega es en la misma direcci√≥n de retiro</label>
    </div>
    <div id="delivery-block" class="address-block" style="margin-top:1.2rem">
      <label><span class="address-icon">üè†</span>Direcci√≥n de entrega</label>
      <div class="hint">Puede ser diferente al punto de retiro</div>
      <input type="text" id="delivery-addr" placeholder="Los Conquistadores 456, Las Condes" />
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="findBranch()">üó∫Ô∏è Encontrar sucursal m√°s cercana</button>
    <div id="map-result">
      <div class="map-title">üìç Sucursal asignada autom√°ticamente</div>
      <div id="branch-info"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goStep(3)">‚Üê Atr√°s</button>
      <button class="btn btn-primary" onclick="goStep(5)">Continuar ‚Üí</button>
    </div>
  </div>

  <div class="card" id="card-5">
    <div class="card-header">
      <div class="card-num">5</div>
      <div><div class="card-title">Resumen del pedido</div><div class="card-sub">Revisa todo antes de confirmar</div></div>
    </div>
    <div id="summary-content"></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goStep(4)">‚Üê Atr√°s</button>
      <button class="btn btn-primary" onclick="confirmOrder()">‚úÖ Confirmar pedido</button>
    </div>
  </div>

</div>

<div id="success-screen">
  <div class="success-icon">üéâ</div>
  <h2>¬°Pedido confirmado!</h2>
  <p>Nos pondremos en contacto para coordinar el retiro. Recibir√°s tus bebidas en el horario acordado.</p>
  <div class="order-code" id="order-code">RT-000000</div><br><br>
  <button class="btn btn-primary" style="display:inline-block;width:auto;padding:.8rem 2rem" onclick="newOrder()">Hacer otro pedido</button>
</div>

<footer>
  <p>‚ôªÔ∏è <span>RetornApp</span> ‚Äì Versi√≥n Beta ¬∑ Hecho en Chile con üíö</p>
  <p style="margin-top:.4rem">¬© 2025 RetornApp SpA ¬∑ Todos los derechos reservados</p>
</footer>

<div class="toast" id="toast"></div>

<script>
const SUPERMARKETS = [
  {id:'jumbo',name:'Jumbo',icon:'üõí'},{id:'unimarc',name:'Unimarc',icon:'üè™'},
  {id:'lider',name:'L√≠der',icon:'üè¨'},{id:'tottus',name:'Tottus',icon:'üõçÔ∏è'},
  {id:'acuenta',name:'Acuenta',icon:'üí∞'},{id:'mayorista',name:'Mayorista 10',icon:'üì¶'},
];
const BEVERAGES = {
  'Gaseosas':[
    {id:'coca',name:'Coca-Cola',icon:'ü•§'},{id:'pepsi',name:'Pepsi',icon:'ü•§'},
    {id:'sprite',name:'Sprite',icon:'ü•§'},{id:'fanta',name:'Fanta',icon:'üçä'},
    {id:'bilz',name:'Bilz',icon:'üçã'},{id:'pap',name:'Pap',icon:'üçé'},
  ],
  'Aguas':[
    {id:'villarica',name:'Villarrica',icon:'üíß'},{id:'cachantun',name:'Cachant√∫n',icon:'üíß'},
    {id:'porvenir',name:'Porvenir',icon:'üíß'},
  ],
  'Jugos y otros':[
    {id:'kem',name:'Kem',icon:'üçπ'},{id:'watts',name:'Watts',icon:'üßÉ'},
    {id:'andina',name:'Andina',icon:'ü•õ'},
  ],
};
const BRANCHES = {
  jumbo:[
    {name:'Jumbo Bilbao',addr:'Av. Bilbao 747, Providencia',lat:-33.432,lng:-70.634},
    {name:'Jumbo La Reina',addr:'Pr√≠ncipe de Gales 6659, La Reina',lat:-33.455,lng:-70.561},
    {name:'Jumbo Apoquindo',addr:'Av. Apoquindo 8601, Las Condes',lat:-33.409,lng:-70.530},
  ],
  unimarc:[
    {name:'Unimarc Irarr√°zaval',addr:'Av. Irarr√°zaval 2345, √ëu√±oa',lat:-33.451,lng:-70.617},
    {name:'Unimarc Macul',addr:'Av. Macul 1785, Macul',lat:-33.480,lng:-70.588},
    {name:'Unimarc P. de Valdivia',addr:'Pedro de Valdivia 1786, Providencia',lat:-33.440,lng:-70.618},
  ],
  lider:[
    {name:'L√≠der Quil√≠n',addr:'Av. Quil√≠n 6100, Pe√±alol√©n',lat:-33.494,lng:-70.557},
    {name:'L√≠der Providencia',addr:'Av. Providencia 1960',lat:-33.430,lng:-70.625},
    {name:'L√≠der La Florida',addr:'Av. V. Mackenna 8520, La Florida',lat:-33.523,lng:-70.577},
  ],
  tottus:[
    {name:'Tottus Costanera',addr:'Av. Andr√©s Bello 2447, Providencia',lat:-33.420,lng:-70.618},
    {name:'Tottus Quilicura',addr:'Av. M.A. Matta 1550, Quilicura',lat:-33.358,lng:-70.726},
  ],
  acuenta:[
    {name:'Acuenta Quinta Normal',addr:"Av. B. O'Higgins 3731, Qta. Normal",lat:-33.441,lng:-70.710},
    {name:'Acuenta San Bernardo',addr:'Av. Padre Hurtado 660, San Bernardo',lat:-33.608,lng:-70.690},
  ],
  mayorista:[
    {name:'Mayorista 10 Maip√∫',addr:'Av. 5 de Abril 4101, Maip√∫',lat:-33.512,lng:-70.774},
    {name:'Mayorista 10 San Miguel',addr:'Av. Departamental 300, San Miguel',lat:-33.498,lng:-70.652},
  ],
};

let state={supermarket:null,bottles:0,beverages:[],pickupAddr:'',deliveryAddr:'',branch:null};
let currentStep=1;

(function init(){buildSuperGrid();buildBevGroups();})();

function buildSuperGrid(){
  document.getElementById('super-grid').innerHTML=SUPERMARKETS.map(s=>`
    <div class="super-card" id="sc-${s.id}" onclick="selectSuper('${s.id}')">
      <div class="super-icon">${s.icon}</div><div class="super-name">${s.name}</div>
      <div class="super-check">‚úì seleccionado</div>
    </div>`).join('');
}
function buildBevGroups(){
  let html='';
  for(const[cat,items]of Object.entries(BEVERAGES)){
    html+=`<div class="bev-group"><div class="bev-group-label">${cat}</div><div class="bev-grid">
    ${items.map(b=>`<div class="bev-card" id="bc-${b.id}" onclick="pickBev('${b.id}','${b.name}','${b.icon}')">
      <div class="bev-icon">${b.icon}</div><div class="bev-name">${b.name}</div></div>`).join('')}</div></div>`;
  }
  document.getElementById('bev-groups').innerHTML=html;
}

function goStep(n){
  if(!validateStep(currentStep))return;
  document.getElementById(`card-${currentStep}`).classList.remove('visible');
  document.getElementById(`step-ind-${currentStep}`).classList.remove('active');
  document.getElementById(`step-ind-${currentStep}`).classList.add('completed');
  if(n<currentStep){for(let i=n;i<=5;i++)document.getElementById(`step-ind-${i}`).classList.remove('completed','active');}
  currentStep=n;
  document.getElementById(`card-${n}`).classList.add('visible');
  document.getElementById(`step-ind-${n}`).classList.add('active');
  document.getElementById(`step-ind-${n}`).classList.remove('completed');
  if(n===5)buildSummary();
  document.getElementById('form-section').scrollIntoView({behavior:'smooth',block:'start'});
}

function validateStep(n){
  if(n===1&&!state.supermarket){showToast('Por favor selecciona un supermercado.');return false;}
  if(n===2&&state.bottles<1){showToast('Debes ingresar al menos 1 botella.');return false;}
  if(n===3&&state.beverages.length<1){showToast('Elige al menos 1 bebida de preferencia.');return false;}
  if(n===4){
    const pa=document.getElementById('pickup-addr').value.trim();
    const da=document.getElementById('delivery-addr').value.trim();
    if(!pa){showToast('Ingresa la direcci√≥n de retiro.');return false;}
    if(!da){showToast('Ingresa la direcci√≥n de entrega.');return false;}
    state.pickupAddr=pa; state.deliveryAddr=da;
  }
  return true;
}

function selectSuper(id){
  document.querySelectorAll('.super-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById(`sc-${id}`).classList.add('selected');
  state.supermarket=id;
}

function changeBottles(delta){
  state.bottles=Math.max(0,state.bottles+delta);
  document.getElementById('bottle-count').textContent=state.bottles;
  const info=document.getElementById('bottles-info');
  if(state.bottles>0){
    const val=state.bottles*130;
    info.style.display='block';
    info.innerHTML=`üí∞ Valor estimado: <strong>$${val.toLocaleString('es-CL')} CLP</strong> &nbsp;¬∑&nbsp; üå± <strong>${(state.bottles*0.3).toFixed(1)}L</strong> de agua reciclada`;
  } else info.style.display='none';
}

function pickBev(id,name,icon){
  const ex=state.beverages.find(b=>b.id===id);
  if(ex){state.beverages=state.beverages.filter(b=>b.id!==id);}
  else{
    if(state.beverages.length>=3){showToast('M√°ximo 3 opciones de preferencia.');return;}
    state.beverages.push({id,name,icon,pick:state.beverages.length+1});
  }
  rebuildBevPicks();
}
function rebuildBevPicks(){
  document.querySelectorAll('.bev-card').forEach(c=>{c.className='bev-card';const b=c.querySelector('.bev-badge');if(b)b.remove();});
  state.beverages.forEach((b,i)=>{
    b.pick=i+1;
    const card=document.getElementById(`bc-${b.id}`);
    card.classList.add(`pick-${b.pick}`);
    const badge=document.createElement('div');
    badge.className='bev-badge'; badge.textContent=b.pick;
    card.appendChild(badge);
  });
}

function toggleSameAddr(){
  const chk=document.getElementById('same-chk').checked;
  document.getElementById('delivery-block').style.display=chk?'none':'block';
  if(chk)document.getElementById('delivery-addr').value=document.getElementById('pickup-addr').value;
}

/* ALGORITMO: Haversine + geocodificaci√≥n por comuna */
function haversine(lat1,lng1,lat2,lng2){
  const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function geocodeSim(addr){
  const a=addr.toLowerCase();
  const map=[
    ['providencia',-33.432,-70.634],['las condes',-33.410,-70.545],
    ['vitacura',-33.390,-70.575],['√±u√±oa',-33.455,-70.615],
    ['la reina',-33.452,-70.563],['pe√±alolen',-33.493,-70.558],
    ['macul',-33.480,-70.588],['san miguel',-33.497,-70.652],
    ['la florida',-33.524,-70.576],['maipu',-33.512,-70.774],
    ['maip√∫',-33.512,-70.774],['quilicura',-33.358,-70.726],
    ['san bernardo',-33.608,-70.690],['quinta normal',-33.441,-70.710],
    ['lo barnechea',-33.350,-70.520],['huechuraba',-33.370,-70.640],
    ['recoleta',-33.410,-70.640],['cerrillos',-33.490,-70.730],
    ['santiago',-33.450,-70.660],
  ];
  for(const[name,lat,lng]of map){if(a.includes(name))return{lat,lng};}
  return{lat:-33.450,lng:-70.660};
}
function findBranch(){
  const pa=document.getElementById('pickup-addr').value.trim();
  let da=document.getElementById('delivery-addr').value.trim();
  if(!pa){showToast('Ingresa la direcci√≥n de retiro primero.');return;}
  if(!da||document.getElementById('same-chk').checked){da=pa;document.getElementById('delivery-addr').value=pa;}
  state.pickupAddr=pa; state.deliveryAddr=da;
  const branches=BRANCHES[state.supermarket]||[];
  if(!branches.length){showToast('No hay sucursales registradas.');return;}
  const pC=geocodeSim(pa),dC=geocodeSim(da);
  const ranked=branches.map(b=>({...b,score:(haversine(pC.lat,pC.lng,b.lat,b.lng)+haversine(dC.lat,dC.lng,b.lat,b.lng))/2})).sort((a,b)=>a.score-b.score);
  state.branch=ranked[0];
  document.getElementById('map-result').style.display='block';
  document.getElementById('branch-info').innerHTML=ranked.map((b,i)=>`
    <div class="map-branch">
      <span>${['üèÜ','ü•à','ü•â'][i]||'‚Ä¢'}</span>
      <span><strong>${b.name}</strong><br><small style="color:var(--muted)">${b.addr}</small></span>
      <span class="map-dist">${b.score.toFixed(1)} km aprox.</span>
    </div>`).join('');
}

function buildSummary(){
  const sm=SUPERMARKETS.find(s=>s.id===state.supermarket);
  const bevList=state.beverages.map((b,i)=>`${['1¬™','2¬™','3¬™'][i]} opci√≥n: ${b.icon} ${b.name}`).join('<br>');
  const val=state.bottles*130, service=1490, total=Math.max(0,val-service);
  const br=state.branch?`${state.branch.name}<br><small style="font-weight:400;color:var(--muted)">${state.branch.addr}</small>`:'Por determinar';
  document.getElementById('summary-content').innerHTML=`
    <div class="summary-row"><span class="summary-key">Supermercado</span><span class="summary-val">${sm?.icon} ${sm?.name}</span></div>
    <div class="summary-row"><span class="summary-key">Botellas a retornar</span><span class="summary-val">${state.bottles} botella${state.bottles!==1?'s':''}</span></div>
    <div class="summary-row"><span class="summary-key">Valor de retorno estimado</span><span class="summary-val">$${val.toLocaleString('es-CL')} CLP</span></div>
    <div class="summary-row"><span class="summary-key">Preferencias de bebidas</span><span class="summary-val" style="line-height:1.6">${bevList}</span></div>
    <div class="summary-row"><span class="summary-key">Direcci√≥n de retiro</span><span class="summary-val">${state.pickupAddr}</span></div>
    <div class="summary-row"><span class="summary-key">Direcci√≥n de entrega</span><span class="summary-val">${state.deliveryAddr}</span></div>
    <div class="summary-row"><span class="summary-key">Sucursal asignada</span><span class="summary-val">${br}</span></div>
    <div class="price-box">
      <div style="display:flex;justify-content:center;gap:2.5rem;margin:.5rem 0">
        <div><div class="price-label">Retorno botellas</div><div style="font-weight:800;font-size:1.1rem;color:#2ecc71">+$${val.toLocaleString('es-CL')}</div></div>
        <div><div class="price-label">Servicio RetornApp</div><div style="font-weight:800;font-size:1.1rem;color:#e74c3c">-$${service.toLocaleString('es-CL')}</div></div>
      </div>
      <div class="price-label" style="margin-top:.8rem">Saldo disponible en bebidas</div>
      <div class="price-amount">$${total.toLocaleString('es-CL')} CLP</div>
      <div class="price-note">* Precio estimado. El valor final depende del stock en tienda.</div>
    </div>`;
}

function confirmOrder(){
  const code='RT-'+Math.floor(100000+Math.random()*900000);
  document.getElementById('order-code').textContent=code;
  document.getElementById('form-section').style.display='none';
  document.getElementById('success-screen').style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
}
function newOrder(){
  state={supermarket:null,bottles:0,beverages:[],pickupAddr:'',deliveryAddr:'',branch:null};
  currentStep=1;
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('visible'));
  document.getElementById('card-1').classList.add('visible');
  for(let i=1;i<=5;i++)document.getElementById(`step-ind-${i}`).classList.remove('active','completed');
  document.getElementById('step-ind-1').classList.add('active');
  buildSuperGrid();buildBevGroups();
  document.getElementById('bottle-count').textContent='0';
  document.getElementById('bottles-info').style.display='none';
  document.getElementById('pickup-addr').value='';
  document.getElementById('delivery-addr').value='';
  document.getElementById('map-result').style.display='none';
  document.getElementById('form-section').style.display='block';
  document.getElementById('success-screen').style.display='none';
  window.scrollTo({top:0,behavior:'smooth'});
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}
</script>
</body>
</html>
